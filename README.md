# MCP Sidecar Lab ğŸš€

é€™æ˜¯ä¸€å€‹å…ˆé€²çš„ç¯„ä¾‹å°ˆæ¡ˆï¼Œå±•ç¤ºå¦‚ä½•å°‡**æ¥­å‹™å¾®æœå‹™ (Business Microservice)** èˆ‡ **MCP (Model Context Protocol) Server Sidecar** å®Œç¾çµåˆï¼Œä¸¦é€éé›²ç«¯åŸç”Ÿæ¶æ§‹éƒ¨ç½²åœ¨å–®ä¸€ Kubernetes Pod ä¸­ã€‚

## ï¿½ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Kubernetes Pod                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       localhost        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                        â”‚   â”‚
â”‚  â”‚    biz (8080)      â”‚    OpenAPI Scan       â”‚  MCP Sidecar (8081)    â”‚   â”‚
â”‚  â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚   â”‚
â”‚  â”‚  - /api/calculate  â”‚                       â”‚  - /mcp (Streamable)   â”‚   â”‚
â”‚  â”‚  - /api/biz-info   â”‚    API Proxy          â”‚  - Swagger UI          â”‚   â”‚
â”‚  â”‚  - /api/manga      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  - Auth Forwarding     â”‚   â”‚
â”‚  â”‚                    â”‚                       â”‚                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â–²                  â”‚
â”‚                                                          â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚   MCP Client / Host   â”‚
                                               â”‚  (AI Agent, Claude,   â”‚
                                               â”‚   MCP Inspector)      â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ï¿½ğŸŒŸ å°ˆæ¡ˆç‰¹æ€§ (Project Features)

é€™å€‹å°ˆæ¡ˆä¸åƒ…åƒ…æ˜¯ç°¡å–®çš„é€šè¨Šï¼Œå®ƒæ•´åˆäº†å¤šé …æŠ€è¡“ï¼š

*   **âš¡ï¸ Spring AI 1.1.2 GA æ•´åˆ**ï¼šæ¡ç”¨ç›®å‰æœ€æ–°çš„ç©©å®šç‰ˆ Spring AIï¼Œåˆ©ç”¨ auto-configuration å¯¦ç¾æ¥µç°¡çš„ Model Context Protocol ä¼ºæœå™¨å»ºç½®ã€‚
*   **ğŸš€ GraalVM Native Image æ”¯æ´**ï¼šæ”¯æ´å°‡ Spring Boot æ‡‰ç”¨ç¨‹å¼ç·¨è­¯ç‚ºåŸç”ŸäºŒé€²ä½æª”ã€‚é€™ä½¿å¾— Sidecar çš„è¨˜æ†¶é«”å ç”¨ä¸‹é™ç´„ **80% (ç´„ 80-100MB)**ï¼Œä¸”å•Ÿå‹•æ™‚é–“ç¸®çŸ­è‡³ **0.1 ç§’**ï¼Œé”åˆ°èˆ‡ Python/Go ç›¸ç•¶çš„è¼•é‡åŒ–æ€§èƒ½ã€‚
*   **ğŸ§© å‹•æ…‹ OpenAPI æƒæ (Dynamic OpenAPI Scanning)**ï¼šçªç ´å‚³çµ±ç¡¬ç·¨ç¢¼å·¥å…·å®šç¾©ï¼ŒSidecar èƒ½è‡ªå‹•å¾é ç«¯ Legacy ç³»çµ±æŠ“å– OpenAPI å®šç¾©ä¸¦è½‰åŒ–ç‚º MCP å·¥å…·ã€‚é€™å¯¦ç¾äº†**é›¶ä»£ç¢¼ (Zero-code)** çš„ AI èƒ½åŠ›æ•´åˆã€‚
*   **ğŸ­ èªç¾©æ˜ å°„å±¤ (Semantic Mapping Layer)**ï¼šé€é `mcp-mapping.json`ï¼Œåœ¨ä¸è®Šå‹•ä»»ä½•åŸå§‹ç¨‹å¼ç¢¼çš„æƒ…æ³ä¸‹ï¼Œè³¦äºˆ Legacy API æ›´å…· AI èªç¾©çš„åç¨±èˆ‡æè¿°ã€‚
*   **ğŸ›  é€šç”¨ä»£ç†æ¨¡å¼ (Generic Pure Proxy)**ï¼šSidecar ä½œç‚ºç´”ä»£ç†é‹è¡Œï¼Œå…·å‚™é€æ˜çš„è«‹æ±‚è½‰ç™¼èƒ½åŠ›ï¼Œèƒ½å®Œç¾å°æ¥åˆ°ä»»ä½•ç¾æœ‰çš„ REST ç³»åˆ—å¾®æœå‹™ã€‚
*   **ğŸ” èªè­‰è½‰ç™¼ (Authentication Forwarding)**ï¼šæ”¯æ´å°‡ MCP Client çš„ `Authorization` Header è‡ªå‹•è½‰ç™¼è‡³å¾Œç«¯ APIï¼Œå¯¦ç¾ç«¯åˆ°ç«¯çš„èº«ä»½é©—è­‰ã€‚
*   **ğŸ–¼ åœ–ç‰‡è™•ç† (Image Processing)**ï¼šè‡ªå‹•è™•ç†å¾Œç«¯ API å›å‚³çš„åœ–ç‰‡ï¼Œè½‰æ›ç‚º Base64 ç·¨ç¢¼çš„ `ImageContent`ã€‚
*   **â˜ï¸ Sidecar è¨­è¨ˆæ¨¡å¼**ï¼šå®Œç¾çš„è·è²¬åˆ†é›¢ (SoC)ã€‚æ¥­å‹™é‚è¼¯å°ˆæ³¨æ–¼æ¥­å‹™ï¼ŒMCP ä¼ºæœå™¨å°ˆæ³¨æ–¼ AI é€šè¨Šï¼Œå…©è€…é€é localhost æ¥µé€Ÿå°æ¥ã€‚
*   **ğŸ“¦ Kubernetes åŸç”Ÿæ”¯æ´**ï¼šå…§å«ç²¾å¿ƒè¨­è¨ˆçš„å¤šå®¹å™¨ Deployment é…ç½®ï¼ŒåŒ…å«å¥åº·æª¢æŸ¥ (Health Checks) èˆ‡è³‡æºéš”é›¢è¨­å®šã€‚

## ğŸ“ å°ˆæ¡ˆçµæ§‹

| ç›®éŒ„ | èªªæ˜ |
|------|------|
| **/biz** | æ¨¡æ“¬ Legacy æ¥­å‹™ç³»çµ± (Spring Boot, Port 8080) |
| **/mcp-server-sidecar** | MCP ä»£ç†æœå‹™ - WebFlux ç‰ˆæœ¬ (Async, Port 8081) |
| **/mcp-server-sidecar-mvc** | MCP ä»£ç†æœå‹™ - Spring MVC ç‰ˆæœ¬ (Sync, Port 8081) |
| **/k8s** | Kubernetes éƒ¨ç½²æ¸…å–® (YAML) |
| **/docs** | æŠ€è¡“æ–‡ä»¶ |

## ğŸ“š æ–‡ä»¶

- [èªè­‰å‚³éæŒ‡å— (Authentication Forwarding)](docs/authentication-forwarding.md) - å¦‚ä½•åœ¨ MCP æ¶æ§‹ä¸­å‚³é OIDC/OAuth2 Token

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æœ¬åœ°é–‹ç™¼

```bash
# 1. å•Ÿå‹•æ¥­å‹™æœå‹™
cd biz && ./mvnw spring-boot:run

# 2. å•Ÿå‹• MCP Sidecar (é¸æ“‡ WebFlux æˆ– MVC ç‰ˆæœ¬)
cd mcp-server-sidecar && ./mvnw spring-boot:run
# æˆ–
cd mcp-server-sidecar-mvc && ./mvnw spring-boot:run

# 3. ä½¿ç”¨ MCP Inspector æ¸¬è©¦
npx @modelcontextprotocol/inspector
# é€£æ¥è‡³ http://localhost:8081/mcp
```

### Docker éƒ¨ç½²

```bash
# ç·¨è­¯ Docker æ˜ åƒæª”
cd biz && docker build -t biz:latest .
cd ../mcp-server-sidecar && docker build -t mcp-server-sidecar:latest .

# å¥—ç”¨ Kubernetes è¨­å®š
kubectl apply -f k8s/deployment.yml
kubectl apply -f k8s/service.yml
```

## ğŸ”® æœªä¾†å±•æœ› (Future Tasks)

- [x] **âš¡ï¸ WebFlux åæ‡‰å¼æ¶æ§‹**ï¼šå·²å®Œæˆã€‚æ”¯æ´å¤§è¦æ¨¡ä¸¦è¡Œæµå¼é€šè¨Šã€‚
- [x] **ğŸ” èªè­‰è½‰ç™¼ (Auth Forwarding)**ï¼šå·²å®Œæˆã€‚æ”¯æ´å°‡ Authorization Header è½‰ç™¼è‡³å¾Œç«¯ã€‚
- [x] **ğŸ–¼ åœ–ç‰‡è™•ç†**ï¼šå·²å®Œæˆã€‚æ”¯æ´ Base64 åœ–ç‰‡å‚³è¼¸ã€‚
- [ ] **ğŸ›¡ ç”Ÿç”¢ç’°å¢ƒå®‰å…¨å¢å¼· (Production Security)**ï¼šæ•´åˆ NetworkPolicyã€API Key èˆ‡ Istio mTLSã€‚
- [ ] **ğŸ“Š å…¨éˆè·¯è§€æ¸¬ (Observability)**ï¼šæ•´åˆ OpenTelemetry èˆ‡ Prometheus ç›£æ§ã€‚
- [ ] **ğŸ” èªç¾©åŒ–æœå°‹èˆ‡å‹•æ…‹è¼‰å…¥ (Registry Mode)**ï¼šå¯¦ç¾å·¥å…·è‡ªå‹•ç™¼ç¾èˆ‡ RAG è¼‰å…¥ã€‚
